<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡¨å››ä½è­‰è³‡æ–™ç·¨è¼¯å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] },
                    colors: { emerald: { 50: '#ecfdf5', 100: '#d1fae5', 500: '#10b981', 600: '#059669', 700: '#047857' } }
                }
            }
        }
    </script>
    <style>
        .drop-zone { transition: all 0.2s; border: 2px dashed #cbd5e1; }
        .drop-zone.drag-over { border-color: #10b981; background-color: #ecfdf5; transform: scale(1.02); }
        .draggable-source { cursor: grab; }
        .draggable-source:active { cursor: grabbing; }
    </style>
</head>
<body class="bg-slate-100 h-screen flex overflow-hidden">

    <!-- å·¦å´ï¼šç´™æœ¬å°ç…§å€ -->
    <div class="w-1/3 bg-slate-800 text-white flex flex-col border-r border-slate-700 shadow-2xl z-10">
        <div class="p-4 border-b border-slate-700 bg-slate-900">
            <h3 class="font-bold text-lg flex items-center">
                <svg class="w-5 h-5 mr-2 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                ç´™æœ¬/ç…§ç‰‡ä¾†æºå€
            </h3>
            <p class="text-xs text-slate-400 mt-1">è«‹ä¸Šå‚³ç…§ç‰‡ä¸¦æ‹–æ›³è‡³å³å´è¡¨æ ¼</p>
        </div>
        
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
            <label class="block w-full border-2 border-dashed border-slate-600 rounded-lg p-8 text-center cursor-pointer hover:border-emerald-500 hover:text-emerald-400 transition text-slate-400">
                <input type="file" class="hidden" multiple accept="image/*" onchange="handleSidebarUpload(this)">
                <span>+ ä¸Šå‚³æ›´å¤šç…§ç‰‡</span>
            </label>
            <div id="sidebarGallery" class="space-y-4">
                <!-- ä¸Šå‚³çš„ç…§ç‰‡æœƒå‡ºç¾åœ¨é€™è£¡ -->
                <div class="bg-slate-700 p-2 rounded-lg">
                    <p class="text-xs text-slate-300 mb-2">ç¯„ä¾‹ç…§ç‰‡</p>
                    <img src="https://images.unsplash.com/photo-1518531933037-91b2f5f229cc?w=400&q=80" 
                         class="w-full h-40 object-cover rounded draggable-source" 
                         draggable="true" ondragstart="drag(event)" crossorigin="anonymous">
                </div>
            </div>
        </div>
    </div>

    <!-- å³å´ï¼šä½è­‰è³‡æ–™ç·¨è¼¯å™¨ -->
    <div class="w-2/3 flex flex-col h-full">
        <div class="bg-white p-4 border-b border-slate-200 shadow-sm flex justify-between items-center z-20">
            <div>
                <h2 class="text-xl font-bold text-slate-800">è¡¨å››ã€ç¤¾å€ç¾æ³ä½è­‰è¡¨</h2>
                <p class="text-sm text-slate-500">å·²ä¾ç…§æŒ‡ç¤ºï¼šç…§ç‰‡é–“æœ‰åˆ†éš”ç·šï¼Œæœ«ç«¯åŠ å…¥ç¸½åˆ†çµ±è¨ˆã€‚</p>
            </div>
            <button onclick="generateWord()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg shadow font-medium flex items-center transition">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                ç”Ÿæˆ Word æª”
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-8 bg-slate-50" id="editorContainer">
            <!-- é€™è£¡æœƒç”± JS è‡ªå‹•ç”Ÿæˆæ‰€æœ‰æŒ‡æ¨™å¡ç‰‡ -->
        </div>
    </div>

    <script>
        // --- 1. å®šç¾©å®Œæ•´çš„æŒ‡æ¨™è³‡æ–™çµæ§‹ (ä¾ç…§ PDF) ---
        const categories = [
            {
                title: "1. ç”Ÿç‰©å¤šæ¨£æ€§ (6)",
                items: ["åŸç”Ÿç¨®æ¤æ ½(1)", "å¤šå±¤æ¬¡æ¤æ ½(1)", "ç”Ÿæ…‹æ™¯è§€æ± (1)", "ç”Ÿæ…‹é‚Šå¡(1)", "ç’°å¢ƒæ•™è‚²è§£èªªç‰Œ(1)", "ç®¡ç†ç¶­è­·æƒ…å½¢(1)"]
            },
            {
                title: "2. ç¶ åŒ–é‡ (10)",
                items: ["è¨‚å®šè¦ç´„é–‹æ”¾å±‹é ‚(1)", "è¨­ç«‹åƒèˆ‡å¼å±‹é ‚è¾²åœ’æˆ–èŠ±åœ’(1)", "ç¶ å±‹é ‚é¢ç©>70mÂ²æˆ–>20%(1)", "ç¶ ç‰†ç¶ å»Š(2)", "ç¶ è¦†ç‡>15%(1)æˆ–>30%(2)", "ç¶ åŒ–è§£èªªç‰Œ(1)", "ç¶ åŒ–ç¶­è­·ç¾æ³(2)"]
            },
            {
                title: "3. æ—¥å¸¸ç¯€èƒ½ (33)",
                items: ["ä½¿ç”¨éš”ç†±è²¼ç´™(1)", "è¨­ç½®å¤–é®é™½(1)", "å…¬å…±ç…§æ˜ç¯€èƒ½(1~3)", "å¸¸é–‹æŒ‡ç¤ºç‡ˆç¯€èƒ½(1~3)", "ç´…å¤–ç·šæ„Ÿæ‡‰(1)", "ç©ºèª¿ç³»çµ±åˆç†ä½¿ç”¨(1)", "ç©ºèª¿ç³»çµ±ä½¿ç”¨ç¾æ³(2)", "é›»æ¢¯è‡ªå‹•é—œé–‰(1)", "å°–å³°æ’é¢¨(1)", "é›»æ¢¯èˆ‡æ’é¢¨ç®¡ç†(2)", "ESPCæˆ–é¡ä¼¼æ¨¡å¼(2)", "ç¯€èƒ½è¨­æ–½ç’°æ•™ç‰Œ(1)", "æ•¸ä½é›»éŒ¶ç®¡ç†(2)", "æ—¥å¸¸ç¯€èƒ½ç¶­è­·(2)"]
            },
             {
                title: "4. æ°´è³‡æº (11)",
                items: ["ç¯€èƒ½Eå¥½å®…(1~10)", "ä½¿ç”¨çœæ°´å™¨æ(1)", "ç®¡ç·šæ¼æ°´æª¢æ¸¬(1)", "é›¨æ°´åˆ©ç”¨(1~2)", "é›¨æ°´ç®¡ç·šé…ç½®(2)", "é›¨æ°´åˆ©ç”¨è¾¦æ³•(1)", "é›œç”¨æ°´ç®¡ç·š(2)", "é›œç”¨æ°´è¾¦æ³•(1)", "æ°´è³‡æºå›æ”¶è§£èªªç‰Œ(1)"]
            },
             {
                title: "5. å†ç”Ÿèƒ½æº (8)",
                items: ["å†ç”Ÿèƒ½æºè©•ä¼°/è¨­ç½®(1~3)", "ç†±æ³µ/å¤ªé™½ç†±æ°´å™¨(2)", "å†ç”Ÿèƒ½æºè§£èªªç‰Œ(1)", "ç™¼é›»è£ç½®ç¶­è­·ç´€éŒ„(2)"]
            },
            {
                title: "6. åƒåœ¾æºé ­æ¸›é‡ (5)",
                items: ["ä¸ä½¿ç”¨å…æ´—é¤å…·(1)", "æ¨å»£æƒœé£Ÿç”Ÿæ´»(1)", "ä»¥ç§Ÿä»£è²·(1)", "çµ±è¨ˆè³‡æ–™åº«æ­éœ²(2)"]
            },
             {
                title: "7. è³‡æºå›æ”¶ (9)",
                items: ["è¨­ç«‹è³‡æºå›æ”¶å€(1)", "è³‡æºå›æ”¶åˆ†é¡(3)", "å»šé¤˜å¦¥å–„æ”¶é‹(1)", "å›æ”¶å®£å°æµ·å ±(1)", "è³‡æºå›æ”¶ç¾æ³(3)"]
            },
            {
                title: "8. å†åˆ©ç”¨ (9)",
                items: ["äºŒæ‰‹ç‰©äº¤æ›(2)", "è½è‘‰å †è‚¥(2)", "å»šé¤˜å †è‚¥(2)", "å»¢é£Ÿç”¨æ²¹å›æ”¶(1)", "å®¶å…·ä¿®ç¹•(1)", "è³‡æºå¾ªç’°è§£èªªç‰Œ(1)"]
            },
             {
                title: "9. å¤§çœ¾é‹è¼¸ (2)",
                items: ["å®£å°æ´»å‹•åŠæµ·å ±(1)", "å‹å–„æ­¥è¡Œç©ºé–“(1)"]
            },
            {
                title: "10. å…±ä¹˜ (2)",
                items: ["è¨­ç«‹å…±ä¹˜è¾¦æ³•(1)", "å¼µè²¼å…±ä¹˜æµ·å ±(1)"]
            },
            {
                title: "11. è‡ªè¡Œè»Š (5)",
                items: ["è‡ªè¡Œè»Šåœè»Šå€(1)", "è‡ªè¡Œè»Šæ¶/ç§Ÿå€Ÿ(1)", "ç¶ è‰²äº¤é€šè§£èªªç‰Œ(1)", "è‡ªè¡Œè»Šä½¿ç”¨ç¾æ³(1)"]
            },
            {
                title: "12. é›»å‹•é‹å…· (11)",
                items: ["é›»å‹•æ©Ÿè»Šåœè»Š/å……é›»(1)", "é›»å‹•æ©Ÿè»ŠæŒæœ‰ç‡(1~2)", "æ¨å»£æ´»å‹•æµ·å ±(1)", "é›»å‹•æ±½è»Šæ¨å»£(1)", "é›»å‹•æ±½è»Šå……é›»è¨­æ–½(1)", "é›»å‹•æ±½è»Šåœè»Šå€(1)", "é›»å‹•æ±½è»ŠæŒæœ‰ç‡(1~2)", "é›»å‹•é‹å…·è§£èªªç‰Œ(1)", "é›»å‹•é‹å…·ä½¿ç”¨ç¾æ³(1)"]
            },
             {
                title: "13. æ°¸çºŒç”Ÿæ´»å¯¦è¸ (10)",
                items: ["çœæ°´å®£å°(1)", "ç”¨æ°´é™ä½(1)", "çœé›»å®£å°(1)", "ç”¨é›»é™ä½(1)", "ç¶ è‰²ç«¶è³½(1)", "æ¨å»£ç¯€é›»çœæ°´æ´»å‹•(1~2)", "åƒè¨ªèˆ‡è§€æ‘©(2)"]
            },
            {
                title: "14. ç®¡ç†åœ˜éšŠ (6)",
                items: ["ç„¡ç´™åŒ–æ¨å»£(1)", "3å€‹æœˆé–‹æœƒè¨è«–(2)", "å°çµ„æˆå“¡ç ”ç¿’(1~4)"]
            },
             {
                title: "15. ç¶ è‰²æ¶ˆè²» (6)",
                items: ["ç¶ è‰²åœ˜è³¼æ©Ÿåˆ¶(1)", "æ¡è³¼ç¶ è‰²å•†å“(2)", "åœ˜è³¼é‡‘é¡é¡åº¦(1~3)"]
            },
             {
                title: "16. ä½ç¢³é£²é£Ÿ (3)",
                items: ["å¼µè²¼å®£å°æµ·å ±(1)", "è¾¦ç†æ´»å‹•åŠç´€éŒ„(2)"]
            },
             {
                title: "17. ç©ºæ°£å“è³ª (4)",
                items: ["è¾¦ç†å®£å°æ´»å‹•(1)", "å…¬å…±å€åŸŸç¤ºç¯„(1)", "ç´™éŒ¢æ¸›ç‡’(1)", "é‡‘ç´™çµ±ä¸€æ”¶å–(1)"]
            },
            {
                title: "18. å‰µæ–°ä½œç‚º (10)",
                items: ["å…·åœ¨åœ°ç‰¹è‰²ä½ç¢³ä½œç‚º(10)"]
            }
        ];

        // --- 2. åˆå§‹åŒ–ä»‹é¢ (è‡ªå‹•ç”Ÿæˆæ‰€æœ‰å¡ç‰‡) ---
        function initEditor() {
            const container = document.getElementById('editorContainer');
            let html = '';
            
            categories.forEach((cat, catIndex) => {
                html += `<div class="mb-8 border-l-4 border-emerald-500 pl-4 bg-emerald-50/50 py-2 rounded-r-lg">
                            <h3 class="text-xl font-black text-emerald-800">${cat.title}</h3>
                         </div>`;
                
                cat.items.forEach((item, itemIndex) => {
                    const uniqueId = `c${catIndex}_i${itemIndex}`;
                    // åœ¨ HTML æ¨™ç±¤ä¸­å„²å­˜ catIndex å’Œ itemIndex ä»¥ä¾¿ç”Ÿæˆ Word æ™‚è¾¨è­˜
                    html += `
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6 overflow-hidden item-card" 
                         data-cat-title="${cat.title}" 
                         data-item-name="${item}" 
                         data-is-first="${itemIndex === 0}" 
                         data-row-span="${cat.items.length}">
                        <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center">
                            <h4 class="font-bold text-slate-700 text-lg">${item}</h4>
                            <select onchange="changeState(this)" class="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block p-2">
                                <option value="exist" selected>ğŸŸ¢ å·²æœ‰æˆæœ</option>
                                <option value="plan">ğŸ”µ æ“¬æ”¹é€ </option>
                                <option value="none">âšª ä¸é©åˆ</option>
                            </select>
                        </div>
                        
                        <div class="p-6 content-area">
                            <!-- ç‹€æ…‹ A: å·²æœ‰æˆæœ -->
                            <div class="state-exist grid grid-cols-3 gap-4 mb-4">
                                <div class="col-span-3 grid grid-cols-3 gap-4">
                                    ${generatePhotoBox('å·¦å´/é æ™¯')}
                                    ${generatePhotoBox('ä¸­é–“/ä¸­æ™¯')}
                                    ${generatePhotoBox('å³å´/ç‰¹å¯«')}
                                </div>
                            </div>

                            <!-- ç‹€æ…‹ B: æ“¬æ”¹é€  -->
                            <div class="state-plan hidden mb-4">
                                <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 mb-4">
                                    <h5 class="text-blue-800 text-sm font-bold mb-2">æ“¬æ”¹é€ ç¤ºæ„åœ–</h5>
                                    <div class="grid grid-cols-3 gap-4">
                                        ${generatePhotoBox('ç¤ºæ„åœ–')}
                                    </div>
                                </div>
                            </div>

                            <!-- ç‹€æ…‹ C: ä¸é©ç”¨ -->
                            <div class="state-none hidden mb-4">
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-gray-500 text-sm">
                                    <span class="font-bold">æç¤ºï¼š</span> å…é™„ç…§ç‰‡ï¼Œè«‹èªªæ˜åŸå› ã€‚
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1 description-label">ç¾æ³æè¿° (å¿…å¡«)</label>
                                <textarea class="w-full border-slate-300 rounded-lg p-3 text-sm focus:ring-emerald-500 focus:border-emerald-500 shadow-sm" rows="2" placeholder="è«‹è¼¸å…¥èªªæ˜..."></textarea>
                            </div>
                        </div>
                    </div>`;
                });
            });
            container.innerHTML = html;
        }

        function generatePhotoBox(label) {
            return `
            <div class="drop-zone border-2 border-dashed border-slate-300 rounded-lg p-2 text-center flex flex-col items-center justify-center min-h-[140px] relative bg-slate-50"
                    ondragover="allowDrop(event)" ondragleave="leaveDrop(event)" ondrop="drop(event)">
                <div class="empty-state pointer-events-none">
                    <span class="text-xs text-slate-500 block">æ‹–æ›³ç…§ç‰‡</span>
                    <span class="text-[10px] text-slate-400 block mt-1">(${label})</span>
                </div>
                <img class="preview-img hidden w-full h-full object-cover rounded absolute inset-0 z-10">
                <button onclick="clearImage(this)" class="hidden absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 z-20 hover:bg-red-600 shadow-md transform scale-75"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>`;
        }

        window.onload = initEditor;

        // --- 3. æ‹–æ›³èˆ‡ç‹€æ…‹åˆ‡æ›é‚è¼¯ ---
        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.src);
            ev.dataTransfer.effectAllowed = "copy";
        }
        function allowDrop(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); }
        function leaveDrop(ev) { ev.currentTarget.classList.remove('drag-over'); }
        function drop(ev) {
            ev.preventDefault();
            const container = ev.currentTarget;
            container.classList.remove('drag-over');
            const src = ev.dataTransfer.getData("text");
            if (src) {
                const img = container.querySelector('.preview-img');
                const empty = container.querySelector('.empty-state');
                const btn = container.querySelector('button');
                img.src = src; img.classList.remove('hidden');
                if(empty) empty.classList.add('hidden');
                if(btn) btn.classList.remove('hidden');
            }
        }
        function clearImage(btn) {
            const container = btn.parentElement;
            const img = container.querySelector('.preview-img');
            const empty = container.querySelector('.empty-state');
            img.src = ''; img.classList.add('hidden'); btn.classList.add('hidden');
            if(empty) empty.classList.remove('hidden');
        }
        function changeState(select) {
            const card = select.closest('.item-card');
            const state = select.value;
            const exist = card.querySelector('.state-exist');
            const plan = card.querySelector('.state-plan');
            const none = card.querySelector('.state-none');
            const label = card.querySelector('.description-label');
            
            exist.classList.add('hidden'); plan.classList.add('hidden'); none.classList.add('hidden');
            
            if (state === 'exist') { exist.classList.remove('hidden'); label.innerText = 'ç¾æ³æè¿° (å¿…å¡«)'; label.classList.remove('text-red-600'); }
            else if (state === 'plan') { plan.classList.remove('hidden'); label.innerText = 'æ“¬æ”¹é€ å…§å®¹æè¿° (å¿…å¡«)'; label.classList.remove('text-red-600'); }
            else { none.classList.remove('hidden'); label.innerText = 'ä¸é©ç”¨èªªæ˜ (å¿…å¡«)'; label.classList.add('text-red-600'); }
        }
        function handleSidebarUpload(input) {
            if(input.files && input.files.length > 0) {
                Array.from(input.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const div = document.createElement('div');
                        div.className = 'bg-slate-700 p-2 rounded-lg relative group mb-4';
                        div.innerHTML = `<img src="${e.target.result}" class="w-full h-40 object-cover rounded draggable-source" draggable="true" ondragstart="drag(event)">`;
                        document.getElementById('sidebarGallery').prepend(div);
                    }
                    reader.readAsDataURL(file);
                });
            }
        }

        // --- 4. ç”Ÿæˆ Word (ç²¾æº–é‚„åŸç‰ˆ) ---
        function base64DataURLToArrayBuffer(dataURL) {
            const base64Regex = /^data:image\/(png|jpg|jpeg|svg\+xml);base64,/;
            if (!base64Regex.test(dataURL)) return null;
            const stringBase64 = dataURL.replace(base64Regex, "");
            let binaryString = window.atob(stringBase64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
            return bytes.buffer;
        }

        async function generateWord() {
            const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, VerticalAlign, TextRun, ImageRun, PageOrientation, AlignmentType, BorderStyle, TableLayoutType } = docx;

            const rows = [];
            
            // --- è¡¨é ­è¨­è¨ˆ (å·¦å³åˆ†å‰²) ---
            rows.push(new TableRow({
                children: [
                    // Col 1 & 2: é …ç›® (è·¨2æ¬„)
                    new TableCell({ children: [new Paragraph({ text: "é …ç›®", bold: true, alignment: AlignmentType.CENTER })], width: { size: 15, type: WidthType.PERCENTAGE }, columnSpan: 2, rowSpan: 2, verticalAlign: VerticalAlign.CENTER }),
                    
                    // Col 3: ç¤¾å€ç¾æ³ (çª„æ¬„ï¼Œç›´æ›¸)
                    new TableCell({ children: [new Paragraph({ text: "ç¤¾å€\nç¾æ³", bold: true, alignment: AlignmentType.CENTER })], width: { size: 5, type: WidthType.PERCENTAGE }, rowSpan: 2, verticalAlign: VerticalAlign.CENTER }),
                    
                    // Col 4: èªªæ˜æ–‡å­— (å¯¬æ¬„) - é€™è£¡éœ€è¦è·¨ 3 å€‹æ¬„ä½ï¼Œå°æ‡‰ä¸‹æ–¹ä¸‰å¼µç…§ç‰‡çš„æ¬„ä½
                    new TableCell({ 
                        children: [
                            new Paragraph({ text: "1.å·²æœ‰æˆæœå‰‡æ’å…¥3å¼µåœ–ç‰‡(ä¸åŒä½ç½®ã€è§’åº¦)ä½è­‰ä¸¦æè¿°ç¾æ³ã€‚", size: 18 }),
                            new Paragraph({ text: "2.æœªæœ‰æˆæœæ¬²æ–¼è¨ˆç•«ä¸­æå‡ºè€…ï¼Œå¯æ’å…¥æ“¬æ”¹é€ çš„ç¤ºæ„åœ–å¾Œï¼Œæè¿°æ“¬æ”¹é€ çš„å…§å®¹ã€‚", size: 18 }),
                            new Paragraph({ text: "3.ç¤¾å€ç¾æ³ä¸é©åˆè©²é …ç›®ï¼Œå‰‡å…æ–¼æä¾›ä½è­‰ï¼Œä½†éœ€æå‡ºèªªæ˜ã€‚", size: 18 }),
                        ],
                        width: { size: 45, type: WidthType.PERCENTAGE },
                        columnSpan: 3, // é—œéµä¿®æ”¹ï¼šè®“èªªæ˜æ¬„ä½è·¨è¶Šä¸‹æ–¹çš„ 3 å€‹ç…§ç‰‡æ¬„ä½
                        rowSpan: 2, 
                        verticalAlign: VerticalAlign.CENTER
                    }),
                    
                    // Col 5: æ–‡å­—æ•˜è¿°
                    new TableCell({ children: [new Paragraph({ text: "æ–‡å­—æ•˜è¿°", bold: true, alignment: AlignmentType.CENTER })], width: { size: 25, type: WidthType.PERCENTAGE }, rowSpan: 2, verticalAlign: VerticalAlign.CENTER }),
                    
                    // Col 6 & 7: å¾—åˆ† (è·¨2æ¬„)
                    new TableCell({ children: [new Paragraph({ text: "å¾—åˆ†", bold: true, alignment: AlignmentType.CENTER })], width: { size: 15, type: WidthType.PERCENTAGE }, columnSpan: 2, verticalAlign: VerticalAlign.CENTER }),
                ]
            }));

            // Row 2: å¾—åˆ†ç´°é … (è‡ªè©•/åˆå¯©)
            rows.push(new TableRow({
                children: [
                    // å‰é¢çš„æ¬„ä½è¢« rowSpan ä½”ç”¨
                    new TableCell({ children: [new Paragraph({ text: "è‡ªè©•", alignment: AlignmentType.CENTER })], width: { size: 7.5, type: WidthType.PERCENTAGE }, verticalAlign: VerticalAlign.CENTER }),
                    new TableCell({ children: [new Paragraph({ text: "åˆå¯©", alignment: AlignmentType.CENTER })], width: { size: 7.5, type: WidthType.PERCENTAGE }, verticalAlign: VerticalAlign.CENTER }),
                ]
            }));

            // --- è³‡æ–™åˆ— (Data Rows) ---
            const cards = document.querySelectorAll('.item-card');
            
            for (let card of cards) {
                const catTitle = card.dataset.catTitle;
                const itemName = card.dataset.itemName;
                const isFirst = card.dataset.isFirst === "true";
                const rowSpanCount = parseInt(card.dataset.rowSpan);
                const state = card.querySelector('select').value;
                const descText = card.querySelector('textarea').value || (state === 'none' ? "æœ¬ç¤¾å€ç„¡æ­¤è¨­æ–½/ä¸é©ç”¨ã€‚" : "");
                
                // è¨ˆç®—åˆ†æ•¸ - é è¨­ç‚ºç©ºå­—ä¸²ï¼Œä¸é©ç”¨å‰‡ç‚º "0"
                let scoreText = ""; 
                if (state === 'none') {
                    scoreText = "0";
                } 

                // å»ºç«‹è©²åˆ—çš„å„²å­˜æ ¼
                const cells = [];

                // 1. å¤§é … (Category) - ä½¿ç”¨ RowSpan
                if (isFirst) {
                    cells.push(new TableCell({ 
                        children: [new Paragraph({ text: catTitle, alignment: AlignmentType.CENTER })], 
                        verticalAlign: VerticalAlign.CENTER,
                        rowSpan: rowSpanCount,
                        width: { size: 5, type: WidthType.PERCENTAGE }
                    }));
                }

                // 2. ç´°é … (Item)
                cells.push(new TableCell({ 
                    children: [new Paragraph({ text: itemName })], 
                    verticalAlign: VerticalAlign.CENTER,
                    width: { size: 10, type: WidthType.PERCENTAGE }
                }));

                // 3, 4, 5. ç…§ç‰‡æ¬„ä½ (åˆ†é–‹3æ ¼ï¼Œé€™æ¨£å°±æœ‰ç·šäº†ï¼)
                if (state !== 'none') {
                    const selector = state === 'exist' ? '.state-exist img.preview-img' : '.state-plan img.preview-img';
                    const imgs = card.querySelectorAll(selector);
                    
                    for(let i=0; i<3; i++) {
                        let cellContent = [];
                        if(imgs[i] && imgs[i].src && !imgs[i].classList.contains('hidden') && imgs[i].src.startsWith('data:')) {
                            const buffer = base64DataURLToArrayBuffer(imgs[i].src);
                            if(buffer) {
                                cellContent.push(new Paragraph({
                                    children: [new ImageRun({
                                        data: buffer,
                                        transformation: { width: 100, height: 75 }, // ç¸®å°é©æ‡‰æ¬„ä½
                                    })],
                                    alignment: AlignmentType.CENTER
                                }));
                            }
                        } else {
                            cellContent.push(new Paragraph(""));
                        }
                        
                        cells.push(new TableCell({
                            children: cellContent,
                            verticalAlign: VerticalAlign.CENTER,
                            width: { size: 15, type: WidthType.PERCENTAGE } // 45% / 3 = 15%
                        }));
                    }
                } else {
                    // ä¸é©ç”¨ï¼šåˆä½µé€™3æ ¼
                    cells.push(new TableCell({
                        children: [new Paragraph({ text: "ä¸é©ç”¨", alignment: AlignmentType.CENTER, color: "888888" })],
                        verticalAlign: VerticalAlign.CENTER,
                        columnSpan: 3,
                        width: { size: 45, type: WidthType.PERCENTAGE }
                    }));
                }

                // 6. æ–‡å­—æ•˜è¿°
                cells.push(new TableCell({ 
                    children: [new Paragraph(descText)], 
                    verticalAlign: VerticalAlign.CENTER,
                    width: { size: 25, type: WidthType.PERCENTAGE }
                }));

                // 7. è‡ªè©•åˆ†æ•¸
                cells.push(new TableCell({ 
                    children: [new Paragraph({ text: scoreText, alignment: AlignmentType.CENTER })], 
                    verticalAlign: VerticalAlign.CENTER,
                    width: { size: 7.5, type: WidthType.PERCENTAGE }
                }));

                // 8. åˆå¯©åˆ†æ•¸
                cells.push(new TableCell({ children: [], verticalAlign: VerticalAlign.CENTER, width: { size: 7.5, type: WidthType.PERCENTAGE } }));

                rows.push(new TableRow({ children: cells }));
            }

            const doc = new Document({
                sections: [{
                    properties: { page: { size: { orientation: PageOrientation.LANDSCAPE } } },
                    children: [
                        new Paragraph({ text: "è¡¨å››ã€ç¤¾å€ç¾æ³ä½è­‰è¡¨", heading: docx.HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER, spacing: { after: 200 } }),
                        new Table({
                            layout: TableLayoutType.FIXED, // å›ºå®šå¯¬åº¦ä½ˆå±€ç¢ºä¿ç…§ç‰‡æ¬„ä½å‡ç­‰
                            width: { size: 100, type: WidthType.PERCENTAGE },
                            rows: rows
                        }),
                        // Footer
                        new Paragraph({ 
                            text: "æ”¹é€ å‰ï¼š      åˆ†ï¼›æ”¹é€ å¾Œï¼š      åˆ†", 
                            alignment: AlignmentType.RIGHT,
                            spacing: { before: 300 },
                            size: 24 // ç¨å¾®å¤§ä¸€é»
                        })
                    ],
                }],
            });

            Packer.toBlob(doc).then(blob => saveAs(blob, "è¡¨å››_ç¤¾å€ç¾æ³ä½è­‰è¡¨_å®Œæ•´ç‰ˆ.docx"));
        }
    </script>
</body>
</html>
